#!/usr/bin/env bash
set -e

APP_DIR="/workspace"
LAYERS_DIR="$2"
ENV_DIR="$3"

echo "==== DreamFactory CNB Buildpack ===="
echo "Building DreamFactory in: $APP_DIR"

# ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ°, Ñ‡Ð¸ composer.json Ð´Ñ–Ð¹ÑÐ½Ð¾ Ñ–ÑÐ½ÑƒÑ”
if [ ! -f "$APP_DIR/composer.json" ]; then
  echo "âŒ composer.json not found in $APP_DIR"
  ls -la "$APP_DIR"
  exit 1
fi

cd "$APP_DIR"

echo "ðŸ“¦ Installing composer dependencies..."
composer install --no-dev --optimize-autoloader

# Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð½Ñ launch Ð¿Ñ€Ð¾Ñ†ÐµÑÑƒ (Ð¼Ñ–Ð½Ñ–Ð¼Ð°Ð»ÑŒÐ½Ð¾ â€” PHP web-server)
mkdir -p "$LAYERS_DIR/launch"
cat > "$LAYERS_DIR/launch/launch.toml" <<EOF
[[processes]]
type = "web"
command = "php"
args = ["-S", "0.0.0.0:8080", "-t", "public"]
default = true
EOF

echo "âœ… DreamFactory CNB Build Complete."

